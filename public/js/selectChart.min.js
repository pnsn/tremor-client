function TimeChart(config,minDate){var datePicker,chartData,rawData,svg,bg,x,y,x0,y0,xAxis,yAxis,line,valueline,brush,idleTimeout,mouseG,brushG,mouse,vertLine,countText,ticks,margin={top:8,right:0,bottom:12,left:14},height=config.height-margin.top-margin.bottom,width=config.width-margin.right-margin.left,idleDelay=350,minimumDate=minDate,dateFormat=config.format,d3Format=d3.utcFormat(config.d3Format);function brushing(){var s=d3.event.selection;if(s){var values=s.map(x.invert,x),start=d3Format(values[0]),end=d3Format(values[1]),str=start+" - "+end+" : "+getTotal(start,end);countText.text(str)}}d3Parse=d3.utcParse(config.d3Format),(svg=d3.select(config.container).append("svg:svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom)).append("defs").append("clipPath").attr("id","clip").append("rect").attr("x",0).attr("y",0).attr("width",width).attr("height",height),svg.append("g").attr("clip-path","url(#clip)").attr("transform","translate("+margin.left+","+margin.top+")"),bg=svg.append("rect").attr("class","background").attr("width",width).attr("height",height).attr("transform","translate("+margin.left+")"),svg.append("text").attr("class","y-axis-text").attr("transform","rotate(-90)").attr("y",0).attr("x",0-height/2).attr("dy","1em").style("text-anchor","middle").text("Counts"),brush=d3.brushX().extent([[0,0],[width,height]]).on("brush",brushing).on("end",brushended).handleSize(height),brushG=svg.append("g").attr("class","brush").call(brush).attr("transform","translate("+margin.left+")"),mouseG=svg.append("g").attr("class","mouse-over-effects"),vertLine=mouseG.append("path").attr("class","mouse-line").attr("pointer-events","none"),countText=mouseG.append("text").attr("transform","translate(20,15)"),valueline=d3.line().x(function(d){return x(d.date)}).y(function(d){return y(d.count)}),brushG.select("rect").on("mouseout",function(){vertLine.style("opacity","0"),countText.style("opacity","0")}).on("mouseover",function(){vertLine.style("opacity","1"),countText.style("opacity","1")}).on("mousemove",function(){var offset=(mouse=d3.mouse(this))[0]+margin.left;if(vertLine.attr("d",function(){var d="M"+offset+","+height;return d+=" "+offset+",0"}),x){var xDate=d3Format(x.invert(mouse[0])),str=xDate+" : "+(rawData[xDate]?rawData[xDate]:0);countText.text(str)}});var justBrushed=!1,doubleClicked;function brushended(){var s=d3.event.selection;if(s){$("#submit").removeClass("inactive"),idleTimeout=null,svg.select(".brush").call(brush.move,null);var range=s.map(x.invert,x),start=moment.utc(range[0]),end=moment.utc(range[1]);justBrushed=!0,setTimeout(function(){justBrushed=!1},idleDelay),vertLine.style("opacity","0"),end.diff(start,"hours")<24&&(start=start.startOf("day"),end=end.endOf("day")),x.domain([start,end]),changeUIDates(start,end),zoom()}else{if(doubleClicked=!1,!idleTimeout)return void(idleTimeout=setTimeout(idled,idleDelay));doubleClicked=!0,reset(),justBrushed=!1}}function zoom(){xAxis.transition().call(d3.axisBottom(x).ticks(ticks)),yAxis.transition().call(d3.axisLeft(y)),line.transition().attr("d",valueline)}function idled(){if(idleTimeout=null,x&&mouse&&!doubleClicked&&!justBrushed){var xDate=d3Format(x.invert(mouse[0]));changeUIDates(xDate=moment.utc(xDate),xDate)}}function getTotal(start,end){var total=0,firstMeas=moment.utc(start);if(start&&end)if(start==end)total=rawData[firstMeas.format(dateFormat)]?rawData[firstMeas.format(dateFormat)]:0;else for(var d=firstMeas;d<=moment.utc(end);d.add(1,"days"))dString=d.format(dateFormat),hours=rawData[dString]?rawData[dString]:0,total+=hours;return total}function getTicks(width){return width/65<10?5:10}function addData(data){chartData=processData(data),x0=d3.extent(chartData,function(d){return d.date.toDate()}),y0=[0,d3.max(chartData,function(d){return d.count})],x=d3.scaleUtc().domain(x0).range([0,width]),y=d3.scaleLinear().domain(y0).range([height,1]),ticks=getTicks(width),line=svg.append("path").data([chartData]).attr("class","line").attr("d",valueline).attr("pointer-events","none").attr("transform","translate("+margin.left+")"),xAxis=svg.append("g").attr("class","x-axis").attr("transform","translate("+margin.left+","+height+")").call(d3.axisBottom(x).ticks(ticks)),yAxis=svg.append("g").attr("class","y-axis").call(d3.axisLeft(y)).attr("transform","translate("+margin.left+")")}function processData(data){rawData=data;for(var processedData=[],today=moment.utc(),firstMeas,d=moment.utc(minimumDate);d<=today;d.add(1,"days"))dString=d.format(dateFormat),hours=rawData[dString]?rawData[dString]:0,processedData.push({date:moment.utc(d),count:hours});return processedData}function updateData(data){chartData=processData(data);var svg=d3.select("body").transition();line.data([chartData]),svg.select(".line").attr("d",valueline).duration(750)}function updateBounds(start,end){start==end&&(end=moment.utc(start).add(1,"day").format(dateFormat)),x.domain([moment.utc(start),moment.utc(end)]),zoom()}function reset(){x.domain(x0),y.domain(y0),zoom()}function resize(innerWidth){width=innerWidth-margin.right-margin.left,x.range([0,width]),y.range([height,0]),ticks=getTicks(width),svg.attr("width",width+margin.right+margin.left).attr("height",height+margin.top+margin.bottom),bg.attr("width",width).attr("height",height),brush=d3.brushX().extent([[0,0],[width,height]]).on("end",brushended).handleSize(height),svg.select(".brush").call(brush),svg.select("#clip rect").attr("width",width).attr("height",height),zoom()}function changeUIDates(start,end){$(config.container).trigger("dateChanged",{start:start,end:end})}return{addData:addData,updateData:updateData,updateBounds:updateBounds,reset:reset,getTotal:getTotal,resize:resize}}