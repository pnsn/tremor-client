function TremorClient(){var config=$.tremorDefaultConfig,datePicker,tremorMap,timeChart,tour,allTremorCounts,selectedDateRange,currentDateRange,bounds,drawLimit=config.drawLimit,apiBaseUrl=config.apiBaseUrl,mapOptions=config.mapOptions,chartOptions=config.chartOptions,tourOptions=config.tourOptions,datePickerOptions=config.datePickerOptions,search_params=new URLSearchParams(window.location.search),datePickerContainer=$('input[name="date-range"]'),coloringSelector=$("#display-type"),magnitude=$("#magnitude"),minDate=config.minDate,defaultColor;tremorMap=new TremorMap(mapOptions),timeChart=new TimeChart(chartOptions,minDate),tour=new Tour(tourOptions),selectedDateRange=new DateRange(search_params.get("starttime"),search_params.get("endtime"),config.dateFormat),currentDateRange=new DateRange(search_params.get("starttime"),search_params.get("endtime"),config.dateFormat),$.each(config.mapOptions.coloringOptions.colors,(function(id,color){color.default&&(defaultColor=id),coloringSelector.prepend("<option value='"+id+"'>"+color.name+"</option>")}));var paramColor=search_params.get("coloring");paramColor&&$("#display-type option[value='"+paramColor+"']").length>0?("magnitude"==paramColor&&$("#magnitude-warning").show(),coloringSelector.val(paramColor)):defaultColor?coloringSelector.val(defaultColor):coloringSelector.val("red");var paramMag=search_params.get("magnitude");function updateMarkers(response){$("#event-list").empty(),tremorMap.setSizing(magnitude.is(":checked")),tremorMap.setColoring(coloringSelector.val()),tremorMap.setRange(currentDateRange.getStart(),currentDateRange.getEnd()),tremorMap.updateMarkers(response),$(".start").text(currentDateRange.getStart()),$(".end").text(currentDateRange.getEnd()),$("#submit").addClass("inactive"),response.count>=drawLimit?$("#event-limit-warning").show():$("#event-limit-warning").hide(),response.count>5e3?($(".sidebar-list").hide(),$("#event-list-warning").show()):($(".sidebar-list").show(),$("#event-list-warning").hide()),$("#no-events-list-warning").hide(),$("#epicenters span").text(response.count),$("#play-events").prop("disabled",!1),$("#loading-overlay").hide()}function noData(){$("#event-list").empty(),$(".start").text(currentDateRange.getStart()),$(".end").text(currentDateRange.getEnd()),$("#submit").addClass("inactive"),$("#event-limit-warning").hide(),$(".sidebar-list").hide(),$("#no-events-list-warning").show(),$("#epicenters span").text(0),$("#loading-overlay").hide()}function updateDateRange(range){if(range[1]>moment.utc())$("#next-day").prop("disabled",!0);else if(range[0]<moment.utc(minDate,config.dateFormat))$("#previous-day").prop("disabled",!0);else{selectedDateRange.setRange(range[0],range[1]);var start=selectedDateRange.getStart(),end=selectedDateRange.getEnd();datePicker.setStartDate(start),datePicker.setEndDate(end),timeChart.updateBounds(start,end),$("#submit").removeClass("inactive"),$("#previous-day, #next-day").prop("disabled",!1)}}function updateUrlParams(){var urlStr="?"+currentDateRange.toString()+"&coloring="+coloringSelector.val()+"&magnitude="+magnitude.is(":checked")+getBoundsString(tremorMap.getBounds());window.history.replaceState&&window.history.replaceState({},"Tremor Map",urlStr)}paramColor&&"heat-map"==paramColor||(magnitude.parent().show(),"true"===paramMag?(magnitude.attr("checked",!0),$("#magnitude-warning").show()):(magnitude.attr("checked",!1),$("#magnitude-warning").hide())),(bounds={lat_max:parseFloat(search_params.get("lat_max")),lat_min:parseFloat(search_params.get("lat_min")),lon_max:parseFloat(search_params.get("lon_max")),lon_min:parseFloat(search_params.get("lon_min"))}).lat_min&&bounds.lat_max&&bounds.lon_min&&bounds.lon_max?(tremorMap.addBounds(bounds),$("#draw-filter").hide(),$("#remove-filter").show()):(bounds=null,$("#draw-filter-text").hide(),$("#draw-filter").show(),$("#remove-filter").hide()),datePickerContainer.daterangepicker(Object.assign(datePickerOptions,{startDate:selectedDateRange.getStart(),endDate:selectedDateRange.getEnd(),maxDate:moment.utc(),minDate:minDate}),(function(start,end,label){selectedDateRange.setRange(start,end),timeChart.updateBounds(selectedDateRange.getStart(),selectedDateRange.getEnd()),$("#submit").removeClass("inactive")})),datePicker=datePickerContainer.data("daterangepicker"),$.ajax({url:apiBaseUrl+"/event/0",dataType:"json"}).done((function(response){$("#tremor-updated span").text(moment.utc(response.properties.time).fromNow())})),getCounts(apiBaseUrl).done((function(response){allTremorCounts=response,timeChart.addData(response),bounds&&getCounts(apiBaseUrl,getBoundsString(bounds)).done((function(response){timeChart.updateData(response),$("path.tremor-line").addClass("modified")})),$(window).on("resize",(function(){timeChart.resize($("#tremor-control-bar").width()-$("#tremor-search").width()-20)}))})),getEvents(apiBaseUrl,currentDateRange.toString(),getBoundsString(bounds)).done((function(response){updateMarkers(response)})).fail((function(jqXHR,textStatus){404===jqXHR.status&&noData()})),$("#tremor-start-tour").click((function(){tour.ended()?tour.restart():tour.start(!0)})),$("#heatmap-warning span").text(drawLimit),$("#chart-buttons a").click((function(e){e.stopPropagation();var range=[];switch($(this).attr("value")){case"day":range=[moment.utc().subtract(1,"days"),moment.utc()];break;case"week":range=[moment.utc().subtract(6,"days"),moment.utc()];break;case"month":range=[moment.utc().subtract(1,"month"),moment.utc()];break;default:range=[moment.utc(minDate),moment.utc()]}range.length>0&&updateDateRange(range)})),$("#previous-day").click((function(){var range;updateDateRange([moment.utc(selectedDateRange.getStart()).subtract(1,"days"),moment.utc(selectedDateRange.getEnd()).subtract(1,"days")])})),$("#next-day").click((function(){var range;updateDateRange([moment.utc(selectedDateRange.getStart()).add(1,"days"),moment.utc(selectedDateRange.getEnd()).add(1,"days")])})),coloringSelector.change((function(){"heat-map"===$(this).val()?magnitude.parent().hide():("magnitude"==paramColor?$("#magnitude-warning").show():$("#magnitude-warning").hide(),magnitude.parent().show()),tremorMap.setColoring($(this).val()),tremorMap.recolorMarkers(),updateUrlParams()})),magnitude.change((function(){tremorMap.setSizing(magnitude.is(":checked")),tremorMap.recolorMarkers(),updateUrlParams(),magnitude.is(":checked")?$("#magnitude-warning").show():$("#magnitude-warning").hide()})),$("#draw-filter").click((function(e){e.preventDefault(),$(this).hide(),$("#remove-filter").show(),$("#draw-filter-text").show(),$.when(tremorMap.startDrawing()).then((function(bounds){getCounts(apiBaseUrl,getBoundsString(bounds)).done((function(response){timeChart.updateData(response),$("#tremor-line").addClass("modified")}))}),(function(status){$("#remove-filter").hide(),$("#draw-filter").show(),$("#draw-filter-text").hide()})),$("#submit").removeClass("inactive")})),$("#remove-filter").click((function(){$(this).hide(),$("path.line").removeClass("modified"),$("#draw-filter").show(),$("#draw-filter-text").hide(),$("#submit").removeClass("inactive"),tremorMap.removeBounds(),timeChart.updateData(allTremorCounts)})),$("#download-container button").click((function(){var dataFormat=$("#download-type").val();if("json"===dataFormat||"csv"===dataFormat){var url=apiBaseUrl+"/events?"+currentDateRange.toString()+"&format="+dataFormat;window.open(url,"_blank")}})),$("#submit").click((function(){$("#loading-overlay").show(),$("#loading-gif").show(),$("#loading-warning").hide(),$("#play-events").prop("disabled",!0),tremorMap.clearLayers();var newRange=selectedDateRange.getRange();currentDateRange.setRange(newRange.start,newRange.end),updateUrlParams(),getEvents(apiBaseUrl,currentDateRange.toString(),getBoundsString(tremorMap.getBounds())).done((function(response){updateMarkers(response)})).fail((function(jqXHR,textStatus){404===jqXHR.status&&noData()}))})),$(chartOptions.container).on("dateChanged",(function(e,dates){selectedDateRange.setRange(dates.start,dates.end),datePicker.setStartDate(selectedDateRange.getStart()),datePicker.setEndDate(selectedDateRange.getEnd()),$("#submit").removeClass("inactive")}))}function getCounts(apiBaseUrl,boundsStr){var str="",request;return boundsStr&&boundsStr.length>0&&(str="?"+boundsStr),$.ajax({url:apiBaseUrl+"/day_counts"+str,dataType:"json"}).done((function(response){return response})).fail((function(jqXHR,textStatus){console.log(jqXHR.status),console.log("Request failed: "+textStatus+" ")})).promise()}function getBoundsString(bounds){var boundsStr="";return bounds&&$.each(bounds,(function(key,value){boundsStr+="&"+key+"="+value})),boundsStr}function getEvents(apiBaseUrl,rangeStr,boundsStr){var request;return $.ajax({url:apiBaseUrl+"/events?"+rangeStr+boundsStr,dataType:"json"}).done((function(response){return $("#loading-warning").hide(),response})).fail((function(jqXHR,textStatus){$("#loading-gif").hide(),$("#loading-warning").show(),500===jqXHR.status?$("#err500").show():404!=jqXHR.status&&$("#err").show(),console.log(jqXHR.status),console.log("Request failed: "+textStatus+" ")})).promise()}function DateRange(startStr,endStr,dateFormat){var start,end;return startStr&&moment.utc(startStr,dateFormat).isValid()?(start=moment.utc(startStr,dateFormat).format(dateFormat),end=endStr&&moment.utc(endStr,dateFormat).isValid()?moment.utc(endStr,dateFormat).format(dateFormat):start):(start=moment.utc().subtract(1,"days").format(dateFormat),end=start),{getStart:function(){return start},getEnd:function(){return end},getRange:function(){return{start:moment.utc(start,dateFormat),end:moment.utc(end,dateFormat)}},setRange:function(s,e){start=s.format(dateFormat),end=e.format(dateFormat)},toString:function(){return"starttime="+start+"T00:00:00&endtime="+end+"T23:59:59"}}}