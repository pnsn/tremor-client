function TremorMap(config){var map,eventMarkers,heatmap,overlays,mapKey,osm,rectangle,drawnRectangle,customMarker,dateStart,dateEnd,shapeOptions=config.boundsOptions,colors=config.coloringOptions.colors,rainbow=new Rainbow,editableLayers=new L.FeatureGroup;function startDrawing(){var dfd=$.Deferred();return editableLayers.clearLayers(),(rectangle=new L.Draw.Rectangle(map,{shapeOptions:shapeOptions})).enable(),map.on(L.Draw.Event.CREATED,function(e){var type=e.layerType,layer=e.layer;editableLayers.addLayer(layer),dfd.resolve(getBounds())}),map.on("draw:drawstop",function(e){dfd.reject("cancel")}),dfd.promise()}function removeBounds(){editableLayers.clearLayers(),rectangle&&(rectangle.disable(),rectangle=null),drawnRectangle&&(drawnRectangle=null)}function addBounds(bounds){editableLayers.clearLayers(),drawnRectangle=L.rectangle([[bounds.lat_max,bounds.lon_max],[bounds.lat_min,bounds.lon_min]],shapeOptions),editableLayers.addLayer(drawnRectangle)}function getBounds(){if(editableLayers.getLayers().length>0){var layer,bounds=editableLayers.getLayers()[0].getBounds();return{lat_max:bounds.getNorth(),lat_min:bounds.getSouth(),lon_max:bounds.getEast(),lon_min:bounds.getWest()}}}function clearLayers(){toggleLayer(!1,heatmap),toggleLayer(!1,eventMarkers)}function drawHeatMap(){clearLayers();var points=[];eventMarkers.eachLayer(function(marker){points.push(marker.getLatLng())}),heatmap=L.heatLayer(points,{radius:15,blur:20}),map.addLayer(heatmap)}function toggleLayer(show,layer){show?map.hasLayer(layer)||map.addLayer(layer):map.hasLayer(layer)&&map.removeLayer(layer)}function recolorMarkers(coloringName,alreadyColored){clearLayers(),"heat-map"==coloringName?(drawHeatMap(),null!=mapKey._map&&map.removeControl(mapKey)):(alreadyColored||(prepareSpectrum(colors[coloringName]),eventMarkers.eachLayer(function(marker){marker.setColoring(coloringName)})),toggleLayer(!0,eventMarkers))}function prepareSpectrum(coloring){coloring&&"time"==coloring.type||"magnitude"==coloring.type?(rainbow.setSpectrumByArray(coloring.fill),null==mapKey._map&&map.addControl(mapKey),mapKey.recolor(coloring)):null!=mapKey._map&&map.removeControl(mapKey)}function updateMarkers(data,coloringName){clearLayers();var firstEventTime=new Date(data.features[0].properties.time),lastEventTime=new Date(data.features[data.features.length-1].properties.time);colors[coloringName]&&prepareSpectrum(colors[coloringName]),eventMarkers=L.geoJSON(data.features,{pointToLayer:function(feature,latlng){var id=feature.properties.id,time=new Date(feature.properties.time),lat=latlng.lat,lng=latlng.lng,mag=feature.properties.amplitude?(Math.round(10*(Math.log10(feature.properties.amplitude)-2.7)/2)/10).toFixed(1):null,timeIndex=(time-firstEventTime)/(lastEventTime-firstEventTime)*100,magIndex=mag?mag/2*100:-1,magString="<div>Magnitude (energy): "+(mag||"no data")+"</div>",timeString=time.toISOString().replace("T"," ").replace(".000Z",""),marker=new customMarker([lat,lng],{timeIndex:timeIndex,id:id,magIndex:magIndex});if(marker.setColoring(coloringName),marker.bindPopup("<div> Time: "+timeString+"</div> <div> Latitude: "+lat+"</div><div>Longitude: "+lng+"</div>"+magString).on("mouseover",function(){$(".active-event").removeClass("active-event"),$(".event-"+id).addClass("active-event")}),data.features.length<5e3){var listItem=$("<li class='tremor-event-nav event-"+id+"'><div>"+timeString+"</div><div>"+(mag?"M"+mag:"no data")+"</div></li>");listItem.click(function(){$(this).addClass("active-event"),marker.openPopup()}).on("mouseenter",function(){$(this).addClass("active-event"),marker.setRadius(6)}).on("mouseout",function(){$(this).removeClass("active-event"),marker.setRadius(config.markerOptions.radius)}),marker.on("click",function(){$(".active-event").removeClass("active-event"),listItem.addClass("active-event"),$(".event-"+id)[0].scrollIntoView()}),$("#event-list").prepend(listItem)}return marker}}),recolorMarkers(coloringName,!0)}return map=new L.Map(config.mapContainer,config.leafletOptions).setView(config.center,config.zoom),osm=new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'}),L.Control.Key=L.Control.extend({onAdd:function(map){var div=L.DomUtil.create("div","map-key map-control");return div.innerHTML="<div id='key-top'></div><div id='key-colored'></div><div id='key-bottom'></div><div id='key-no-data'><span> No Data: </span><div></div></div>",div},recolor:function(coloring){"magnitude"==coloring.type?($("#key-top").text("Me = 2.0"),$("#key-bottom").text("0.0"),$("#key-no-data").show()):($("#key-top").text(dateEnd),$("#key-bottom").text(dateStart),$("#key-no-data").hide());var str="";$.each(coloring.fill,function(i,color){str+=","+color}),$("#key-colored").css("background-image","linear-gradient(to top"+str+")")}}),L.control.key=function(opts){return new L.Control.Key(opts)},mapKey=L.control.key({position:"topleft"}),rainbow=new Rainbow,customMarker=L.CircleMarker.extend({options:{weight:config.markerOptions.weight,opacity:config.markerOptions.opacity,fillOpacity:config.markerOptions.fillOpacity,radius:config.markerOptions.radius,magIndex:-1,timeIndex:0,id:"",fill:"white",outline:"black"},setColoring:function(coloring){var fill;if(colors[coloring]){switch(colors[coloring].type){case"magnitude":fill=this.options.magIndex>=0?"#"+rainbow.colorAt(this.options.magIndex):"#ababab";break;case"time":fill="#"+rainbow.colorAt(this.options.timeIndex);break;default:fill=colors[coloring].fill}this.setStyle({fillColor:fill,color:colors[coloring].outline})}}}),overlays={Seismometers:L.geoJSON(seismometersGeoJSON,{pointToLayer:function(feature,latlng){return L.marker(latlng,{icon:L.icon({iconUrl:"/assets/map/station.png",iconSize:[10,8]})}).bindPopup("<div>"+feature.properties.station+"</div>")}}),"Past Tremor":L.geoJSON(pastTremorGeoJSON,{style:pastTremorGeoJSON.properties.style}),"JDF Plate Contours":L.geoJSON(contoursGeoJSON,{style:function(feature){return feature.properties.style}})},map.addLayer(osm),L.control.scale().addTo(map),map.addLayer(editableLayers),L.control.layers({},overlays).addTo(map),L.Control.include({_refocusOnMap:L.Util.falseFn}),{recolorMarkers:recolorMarkers,updateMarkers:updateMarkers,addBounds:addBounds,startDrawing:startDrawing,removeBounds:removeBounds,getBounds:getBounds,clearLayers:clearLayers,setRange:function(start,end){dateStart=start,dateEnd=end}}}