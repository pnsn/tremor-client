function TremorMap(config){var map,eventMarkers,heatmap,overlays,mapKey,osm,rectangle,drawnRectangle,customMarker,shapeOptions=config.boundsOptions,colors=config.coloringOptions.colors,rainbow=new Rainbow,rainbowDark=new Rainbow,editableLayers=new L.FeatureGroup;function startDrawing(){var dfd=$.Deferred();return editableLayers.clearLayers(),(rectangle=new L.Draw.Rectangle(map,{shapeOptions:shapeOptions})).enable(),map.on(L.Draw.Event.CREATED,function(e){var type=e.layerType,layer=e.layer;editableLayers.addLayer(layer),dfd.resolve(getBounds())}),map.on("draw:drawstop",function(e){dfd.reject("cancel")}),dfd.promise()}function removeBounds(){editableLayers.clearLayers(),rectangle&&(rectangle.disable(),rectangle=null),drawnRectangle&&(drawnRectangle=null)}function addBounds(bounds){editableLayers.clearLayers(),drawnRectangle=L.rectangle([[bounds.lat_max,bounds.lon_max],[bounds.lat_min,bounds.lon_min]],shapeOptions),editableLayers.addLayer(drawnRectangle)}function getBounds(){if(editableLayers.getLayers().length>0){var layer,bounds=editableLayers.getLayers()[0].getBounds();return{lat_max:bounds.getNorth(),lat_min:bounds.getSouth(),lon_max:bounds.getEast(),lon_min:bounds.getWest()}}}function clearLayers(){toggleLayer(!1,heatmap),toggleLayer(!1,eventMarkers)}function drawHeatMap(){clearLayers();var points=[];eventMarkers.eachLayer(function(marker){points.push(marker.getLatLng())}),heatmap=L.heatLayer(points,{radius:15,blur:20}),map.addLayer(heatmap)}function toggleLayer(show,layer){show?map.hasLayer(layer)||map.addLayer(layer):map.hasLayer(layer)&&map.removeLayer(layer)}function recolorMarkers(coloringName,alreadyColored){clearLayers(),"heat-map"==coloringName?(drawHeatMap(),null!=mapKey._map&&map.removeControl(mapKey)):(alreadyColored||(prepareSpectrum(colors[coloringName]),eventMarkers.eachLayer(function(marker){marker.setColoring(coloringName)})),toggleLayer(!0,eventMarkers))}function prepareSpectrum(coloring){coloring&&"spectrum"==coloring.type?(rainbow.setSpectrumByArray(coloring.fill),rainbowDark.setSpectrumByArray(coloring.outline),null==mapKey._map&&map.addControl(mapKey),mapKey.recolor(coloring)):null!=mapKey._map&&map.removeControl(mapKey)}function updateMarkers(data,coloringName){clearLayers();var firstEventTime=new Date(data.features[0].properties.time),lastEventTime=new Date(data.features[data.features.length-1].properties.time),timeIndex,time,id,lat,lng;prepareSpectrum(colors[coloringName]),eventMarkers=L.geoJSON(data.features,{pointToLayer:function(feature,latlng){time=new Date(feature.properties.time),id=feature.properties.id,lat=latlng.lat,lng=latlng.lng;var marker=new customMarker([lat,lng],{timeIndex:timeIndex=(time-firstEventTime)/(lastEventTime-firstEventTime)*100,id:id});if(marker.setColoring(coloringName),marker.bindPopup("<div> Time: "+feature.properties.time+"</div> <div> Latitude: "+lat+"</div><div>Longitude: "+lng+"</div>").on("mouseover",function(){$(".active-event").removeClass("active-event"),$(".event-"+id).addClass("active-event")}),data.features.length<5e3){var listItem=$("<li class='event-nav event-"+id+"'>"+feature.properties.time+"</li>");listItem.click(function(){$(this).addClass("active-event"),marker.openPopup()}).on("mouseenter",function(){$(this).addClass("active-event"),marker.setRadius(6)}).on("mouseout",function(){$(this).removeClass("active-event"),marker.setRadius(config.markerOptions.radius)}),marker.on("click",function(){$(".active-event").removeClass("active-event"),listItem.addClass("active-event")}),$("#event-list").append(listItem)}return marker}}),recolorMarkers(coloringName,!0)}return map=new L.Map(config.mapContainer,config.leafletOptions).setView(config.center,config.zoom),osm=new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'}),L.Control.Key=L.Control.extend({onAdd:function(map){var div=L.DomUtil.create("div","map-key map-control");return div.innerHTML="<div class='end'></div><div id='key-colored'></div><div class='start'></div>",div},recolor:function(coloring){var str="";$.each(coloring.fill,function(i,color){str+=","+color}),$("#key-colored").css("background-image","linear-gradient(to top"+str+")")}}),L.control.key=function(opts){return new L.Control.Key(opts)},mapKey=L.control.key({position:"topleft"}),rainbow=new Rainbow,rainbowDark=new Rainbow,customMarker=L.CircleMarker.extend({options:{weight:config.markerOptions.weight,opacity:config.markerOptions.opacity,fillOpacity:config.markerOptions.fillOpacity,radius:config.markerOptions.radius,timeIndex:0,id:"",fill:"white",outline:"black"},setColoring:function(coloring){colors[coloring]&&("spectrum"==colors[coloring].type?this.setStyle({fillColor:"#"+rainbow.colorAt(this.options.timeIndex),color:"#"+rainbowDark.colorAt(this.options.timeIndex)}):this.setStyle({fillColor:colors[coloring].fill,color:colors[coloring].outline}))}}),overlays={Seismometers:L.geoJSON(seismometersGeoJSON,{pointToLayer:function(feature,latlng){return L.marker(latlng,{icon:L.icon({iconUrl:"assets/Station.png",iconSize:[10,8]})}).bindPopup("<div>"+feature.properties.station+"</div>")}}),"Past Tremor":L.geoJSON(pastTremorGeoJSON,{style:pastTremorGeoJSON.properties.style}),"JDF Plate Contours":L.geoJSON(contoursGeoJSON,{style:function(feature){return feature.properties.style}})},map.addLayer(osm),L.control.scale().addTo(map),map.addLayer(editableLayers),L.control.layers({},overlays).addTo(map),L.Control.include({_refocusOnMap:L.Util.falseFn}),{recolorMarkers:recolorMarkers,updateMarkers:updateMarkers,addBounds:addBounds,startDrawing:startDrawing,removeBounds:removeBounds,getBounds:getBounds,clearLayers:clearLayers}}